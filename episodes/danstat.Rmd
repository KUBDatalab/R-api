---
title: 'What about danstat?'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- Is there an easier way to access Statistics Denmark?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Use a package to do the API-calls to Statistics Denmark
- Connect to Statistics Denmark, and extract data
- Create a list of lists to control the variables to be extracted
- Using the danstat package


::::::::::::::::::::::::::::::::::::::::::::::::


```{r setup, include = FALSE, echo=FALSE, message=FALSE, warning=FALSE}

library(danstat)
library(tidyverse)
```

Please note: These pages are autogenerated. Some of the API-calls may fail during
that process. We are figuring out what to do about it, but please excuse us 
for any red errors on the pages for the time being.


## Is there an easier way?

Many larger online services provide packages for easier access to their APIs.

Popular services might not have to do this, because enthusiasts write packages
themselves.

A package called `danstat` is available, and makes it easier to extract data from
Statistics Denmark.


## The danstat package/library

Previously we retrieved at table with demographic data from Statistics Denmark.

How can we get that table using the danstat package?

Before using the library, we will need to install it:

```{r how-to-install-danstat, eval=FALSE}
install.packages("danstat")
```

Some installations of R may have problems installing it. In that case, try this:

```{r alternative-danstat-install, eval =FALSE}
install.packages("remotes")
library(remotes)
remotes:install_github("cran/danstat")
```

After installation, we load the library using the library function. And then 
we can access the functions included in the library:

The danstat package contain four functions, equivalent to the four endpoints
we discussed earlier.

The `get_subjects()` function sends a request to the Statistics Denmark API, asking
for a list of the subjects. The information is returned to our script, and the
`get_subjects()` function presents us with a dataframe containing the information.

```{r get-subjects}
library(danstat)
subjects <- get_subjects()
subjects
```


We get the 10 major subjects from Statistics Denmark we have seen before.
As before, each of them have sub-subjects.

If we want to take a closer look at the 
subdivisions of a given subject, we use the `get_subjects()` function again,
this time specifying which subject we are interested in:

Let us try to get the sub-subjects from the subject 1 - containing information
about populations and elections:

```{r get-sub-subjects}
sub_subjects <- get_subjects(subjects = 1)
sub_subjects
```

The result is a bit complicated. The column "subjects" in the resulting dataframe
contains another dataframe. We access it like we normally would access a 
column in a dataframe:

```{r show-sub-sub-subjects}
sub_subjects$subjects
```

We can continue diving into this, and will end up with subject "20021	Population figures".


## Which datatables exists?

We ended up with a specific subject, 

*20021	Population figures*

And can use the `get_tables()` function to get information about the tables available:

```{r get-tables}
tables <- get_tables(subjects="20021")
tables |> head()
```

We have seen this information before, and can now use the `get_table_metadata()` function
to extract metadata on specific tables: 

```{r get-metadata}
metadata <- get_table_metadata("FOLK1A", variables_only = TRUE)
metadata
```

We use the `variables_only = TRUE` to remove eg. contact information to Statistics Denmark.


What kind of values can the individual datapoints take?

```{r get-values}
metadata |> 
  slice(4) |> 
  pull(values)
```

We use the slice function from tidyverse to pull out the fourth row of the 
dataframe, and the pull-function to pull out the values in the values
column.

The same trick can be done for the other fields in the table:

```{r municipalites}
metadata |> 
  slice(1) |> 
  pull(values) |> 
  pluck(1) |> 
  head()
```
Here we see the individual municipalities in Denmark. 


## Which variables do we want?

As before we need to specify the variables we want in our answer.


These variables, and the values of them, need to be specified when we 
pull the data from Statistics Denmark.

We have seen how to do that using the `POST()` function, it is done similarly using the `danstat` package:

```{r list-of-lists}
variables <- list(list(code = "OMRÃ…DE", values = NA),
                  list(code = "CIVILSTAND", values = c("U", "G", "E", "F")),
                  list(code = "Tid", values = NA)
              )

```

And now we can call the `get_data()` function and retrieve data:

```{r getting-data}
data <- get_data(table_id = "FOLK1A", variables = variables)
```

It takes a short moment. But now we have a dataframe containing the data we 
requested:

```{r head-of-data}
head(data)
```




::::::::::::::::::::::::::::::::::::: keypoints 

- Larger services often provide packages to make it easier to use their API.

::::::::::::::::::::::::::::::::::::::::::::::::

